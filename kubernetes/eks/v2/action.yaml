name: Deploy to Amazon EKS
description: "Centralized EKS deployment without metrics overhead"
inputs:
  service_name: { required: true }
  image_tag: { required: true }
  app_port: { required: true }
  active_profile: { required: true }
  aws_region: { required: true }
  ecr_repository: { required: true }
  eks_cluster_name: { required: true }
  docker_registry: { required: true }
  k8s_namespace: { required: true }
  skip_build: { default: 'false' }
  dockerfile_path: { default: 'Dockerfile' }

runs:
  using: "composite"
  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ inputs.aws_access_key_id }}
        aws-secret-access-key: ${{ inputs.aws_secret_access_key }}
        aws-region: ${{ inputs.aws_region }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build and Push (Conditional)
      if: inputs.skip_build == 'false'
      shell: bash
      run: |
        FULL_IMAGE="${{ inputs.docker_registry }}/${{ inputs.ecr_repository }}:${{ inputs.image_tag }}"
        docker build -t $FULL_IMAGE -f ${{ inputs.dockerfile_path }} .
        docker push $FULL_IMAGE

    - name: Update kube config
      shell: bash
      run: aws eks update-kubeconfig --name ${{ inputs.eks_cluster_name }} --region ${{ inputs.aws_region }}

    - name: Deploy to EKS
      shell: bash
      env:
        IMAGE_URL: "${{ inputs.docker_registry }}/${{ inputs.ecr_repository }}:${{ inputs.image_tag }}"
        SERVICE_NAME: ${{ inputs.service_name }}
        NAMESPACE: ${{ inputs.k8s_namespace }}
        APP_PORT: ${{ inputs.app_port }}
        ACTIVE_PROFILE: ${{ inputs.active_profile }}
      run: |
        if [ -f "k8s/deployment.yaml" ]; then
          TEMPLATE_PATH="k8s/deployment.yaml"
        else
          TEMPLATE_PATH="${{ github.action_path }}/base-deployment.yaml"
        fi

        mkdir -p .generated_k8s
        envsubst < $TEMPLATE_PATH > .generated_k8s/final.yaml
        kubectl apply -f .generated_k8s/final.yaml
        
        kubectl rollout status deployment/${{ inputs.service_name }} -n ${{ inputs.k8s_namespace }}